<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<!--  &lt;!&ndash; Font Awesome &ndash;&gt;-->
<!--  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />-->


  <style>
    .admin-page {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: 100px;
    }
    .nav-item {
      max-width: 200px;
      height: 50px;
      background-color: whitesmoke;
      margin: 10px;
    }
    .nav-item .nav-link {
      font-size: 25px;
      text-align: center;
      padding-top: 10px;
    }
    table {
      margin-top: 70px;
    }
    table.table th {
      font-size: 20px;
    }
    table.table td {
      font-size: 20px;
    }
    th, td {
      word-wrap: break-word;
    }

  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">HOMEMATE</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="d-flex align-items-center ml-auto">
      <a href="javascript:void(0);" onclick="logout()" style="color: white;">로그아웃</a>
    </div>

    <script>
      function logout() {
        fetch('/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
        }).then(function(response) {
          if (response.ok) {
            // Perform any additional actions after logout if needed
            console.log('Logout successful');
            window.location.href = '/';
          } else {
            console.error('Logout failed');
          }
        });
      }
    </script>
  </div>
</nav>




<div class="admin-page">
  <ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <a class="nav-link" th:href="@{/admin/user/chart}">회원관리</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" th:href="@{/admin/building/chart}">매물관리</a>
    </li>
    <li class="nav-item" role="presentation">
      <a class="nav-link" th:href="@{/admin/article/chart}">게시글관리</a>
    </li>
  </ul>
  <!-- 검색 컴포넌트 추가 -->
  <div class="row my-3">
    <div class="col-6">
      <a th:href="@{/building/create}" class="btn btn-primary">매물 등록하기</a>
    </div>
    <div class="col-6">
      <div class="input-group">
        <input type="text" id="search_kw" class="form-control" th:value="${kw}">
        <button class="btn btn-outline-secondary" type="button" id="btn_search">찾기</button>
      </div>
    </div>
  </div>




  <table class="table" style="width: 3000px;">
    <thead>
    <tr>
      <th scope="col">번호</th>
      <th scope="col">이름</th>
      <th scope="col">주소</th>
      <th scope="col">특징</th>
      <th scope="col">층수</th>
      <th scope="col">보증금</th>
      <th scope="col">매매가</th>
      <th scope="col">임대료</th>
      <th scope="col">입주가능일</th>
      <th scope="col">복층여부</th>
      <th scope="col">방향</th>
      <th scope="col">주차가능수</th>
      <th scope="col">중개소이름</th>
      <th scope="col">중개소번호</th>
      <th scope="col">종류</th>
      <th scope="col">방수/욕실수</th>
      <th scope="col">거래유형</th>
      <th scope="col">제목</th>
      <th scope="col"></th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="building : ${buildingList}">
      <td th:text="${building.id}" scope="row"></td>
      <td th:text="${building.buildingName}"></td>
      <td th:text="${building.address}"></td>
      <td th:text="${building.content}"></td>
      <td th:text="${building.floor}"></td>
      <td th:text="${building.warantPrice}"></td>
      <td th:text="${building.dealPrice}"></td>
      <td th:text="${building.rentPrice}"></td>
      <td th:text="${building.moveInDate}"></td>
      <td th:text="${building.checkDuplex}"></td>
      <td th:text="${building.direction}"></td>
      <td th:text="${building.numberOfParking}"></td>
      <td th:text="${building.realterName}"></td>
      <td th:text="${building.realterNumber}"></td>
      <td th:text="${building.buildingField}"></td>
      <td th:text="${building.numberOfRoom}"></td>
      <td th:text="${building.transactionType}"></td>
      <td th:text="${building.title}"></td>
      <td class="row">
        <div class="col">
          <div class="col">
            <button type="button" class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#exampleModal0"
                    th:attr="data-building-id=${building.id}"
                    style="font-size: 24px; padding: 10px 20px;">
              수정
            </button>
            <button type="button" class="btn btn-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#exampleModal"
                    th:attr="data-building-id=${building.id}"
                    style="font-size: 24px; padding: 10px 20px;">
              삭제
            </button>
            <!-- 수정 모달 -->
            <div class="modal fade" id="exampleModal0" tabindex="-1" aria-labelledby="exampleModalLabel0" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel0" style="font-size: 30px;">매물 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <!--                  &lt;!&ndash; 사용자 닉네임을 표시 &ndash;&gt;-->
                    <!--                  <p>기존 닉네임: <span th:text="${member.nickName}"></span></p>-->

                    <form id="updateBuildingForm" onsubmit="event.preventDefault(); saveBuildingData();">
                      <div>
                        <input type="hidden" id="buildingId" th:value="${building.id}" />
                      </div>
                      <div>
                        <label for="buildingName" style="font-size: 24px;">매물 이름:</label>
                        <input type="text" id="buildingName" th:value="${building.buildingName}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="address" style="font-size: 24px;">매물 주소:</label>
                        <input type="text" id="address" th:value="${building.address}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="content" style="font-size: 24px;">매물 특징:</label>
                        <input type="text" id="content" th:value="${building.content}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="floor" style="font-size: 24px;">층수:</label>
                        <input type="text" id="floor" th:value="${building.floor}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="warantPrice" style="font-size: 24px;">보증금:</label>
                        <input type="text" id="warantPrice" th:value="${building.warantPrice}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="dealPrice" style="font-size: 24px;">매매가:</label>
                        <input type="text" id="dealPrice" th:value="${building.dealPrice}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="rentPrice" style="font-size: 24px;">임대료:</label>
                        <input type="text" id="rentPrice" th:value="${building.rentPrice}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="moveInDate" style="font-size: 24px;">입주가능일:</label>
                        <input type="text" id="moveInDate" th:value="${building.moveInDate}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="checkDuplex" style="font-size: 24px;">복층여부:</label>
                        <input type="text" id="checkDuplex" th:value="${building.checkDuplex}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="direction" style="font-size: 24px;">방향:</label>
                        <input type="text" id="direction" th:value="${building.direction}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="numberOfParking" style="font-size: 24px;">주차가능수:</label>
                        <input type="text" id="numberOfParking" th:value="${building.numberOfParking}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="realterName" style="font-size: 24px;">중개소이름:</label>
                        <input type="text" id="realterName" th:value="${building.realterName}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="realterNumber" style="font-size: 24px;">중개소번호:</label>
                        <input type="text" id="realterNumber" th:value="${building.realterNumber}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="buildingField" style="font-size: 24px;">종류:</label>
                        <input type="text" id="buildingField" th:value="${building.buildingField}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="numberOfRoom" style="font-size: 24px;">방수/욕실수:</label>
                        <input type="text" id="numberOfRoom" th:value="${building.numberOfRoom}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="transactionType" style="font-size: 24px;">거래유형:</label>
                        <input type="text" id="transactionType" th:value="${building.transactionType}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <label for="title" style="font-size: 24px;">제목:</label>
                        <input type="text" id="title" th:value="${building.title}" style="font-size: 24px;" />
                      </div>
                      <div>
                        <button type="submit" class="btn btn-primary" style="font-size: 30px; padding: 10px 20px;">저장</button>
                      </div>
                    </form>


                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 30px; padding: 10px 20px;">취소</button>
                  </div>
                </div>
              </div>
            </div>

            <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
            <script>

              function saveBuildingData(modalId) {


                var buildingId = document.getElementById("buildingId").value;
                var newBuildingName = document.getElementById("buildingName").value;
                var newAddress = document.getElementById("address").value;
                var newContent = document.getElementById("content").value;
                var newFloor = document.getElementById("floor").value;
                var newWarantPrice = document.getElementById("warantPrice").value;
                var newDealPrice = document.getElementById("dealPrice").value;
                var newRentPrice = document.getElementById("rentPrice").value;
                var newMoveInDate = document.getElementById("moveInDate").value;
                var newCheckDuplex = document.getElementById("checkDuplex").value;
                var newDirection = document.getElementById("direction").value;
                var newNumberOfParking = document.getElementById("numberOfParking").value;
                var newRealterName = document.getElementById("realterName").value;
                var newrealterNumber = document.getElementById("realterNumber").value;
                var newBuildingField = document.getElementById("buildingField").value;
                var newNumberOfRoom = document.getElementById("numberOfRoom").value;
                var newTransactionType = document.getElementById("transactioonType").value;
                var newTitle = document.getElementById("title").value;

                $('#'+modalId).modal('hide');



                var data = {
                  buildingId: buildingId,
                  buildingName: newBuildingName,
                  address: newAddress,
                  content: newContent,
                  floor: newFloor,
                  warantPrice: newWarantPrice,
                  dealPrice: newDealPrice,
                  rentPrice: newRentPrice,
                  moveInDate: newMoveInDate,
                  checkDuplex: newCheckDuplex,
                  direction: newDirection,
                  numberOfParking: newNumberOfParking,
                  realterName: newRealterName,
                  realterNumber: newrealterNumber,
                  buildingField: newBuildingField,
                  numberOfRoom: newNumberOfRoom,
                  transactionType: newTransactionType,
                  title: newTitle
                };

                fetch("/admin/update/building", {
                  // credentials: 'include',
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json"

                  },
                  // body: new URLSearchParams(data).toString()
                  body: JSON.stringify(data)
                })
                        .then(response => {
                          if (response.ok) {
                            $('#exampleModal0').modal('hide');
                            location.reload();
                            alert("수정 성공!")

                            document.getElementById("buildingName").innerText = newBuildingName;
                            document.getElementById("address").innerText = newAddress;
                            document.getElementById("content").innerText = newContent;
                            document.getElementById("floor").innerText = newFloor;
                            document.getElementById("warantPrice").innerText = newWarantPrice;
                            document.getElementById("dealPrice").innerText = newDealPrice;
                            document.getElementById("rentPrice").innerText = newRentPrice;
                            document.getElementById("moveInDate").innerText = newMoveInDate;
                            document.getElementById("checkDuplex").innerText = newCheckDuplex;
                            document.getElementById("direction").innerText = newDirection;
                            document.getElementById("numberOfParking").innerText = newNumberOfParking;
                            document.getElementById("realterName").innerText = newRealterName;
                            document.getElementById("realterNumber").innerText = newrealterNumber;
                            document.getElementById("buildingField").innerText = newBuildingField;
                            document.getElementById("numberOfRoom").innerText = newNumberOfRoom;
                            document.getElementById("transactionType").innerText = newTransactionType;
                            document.getElementById("title").innerText = newTitle;

                          } else {
                            console.error("오류 발생");
                            alert("매물을 수정할 수 없습니다.")
                          }
                        })
                        .catch(error => {
                          console.error("오류 발생: " + error);
                        });

              }
            </script>


            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel" style="font-size: 30px;">매물 삭제</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    정말 삭제하시겠습니까?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="font-size: 30px; padding: 10px 20px;">
                      취소
                    </button>
                    <form th:action="@{/admin/delete/building}" method="post">
                      <input type="hidden" th:name="buildingId" th:value="${building.id}" />
                      <button type="submit" class="btn btn-danger" style="font-size: 30px; padding: 10px 20px;">삭제</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </td>
    </tr>
    </tbody>
  </table>
  <div style="margin-top: 300px;">
    <ul class="pagination pagination-lg">
      <li th:if="${currentPage > 0}" class="page-item">
        <a class="page-link" th:href="@{/admin/building/chart(page=${currentPage - 5}, size=${pageSize})}">&laquo;</a>
      </li>
      <li th:each="i : ${#numbers.sequence(currentPage, currentPage + 4)}" class="page-item">
        <a class="page-link" th:if="${i < buildingList.totalPages}" th:href="@{/admin/building/chart(page=${i}, size=${pageSize})}" th:text="${i + 1}"></a>
      </li>
      <li th:if="${currentPage + 5 < buildingList.totalPages}" class="page-item">
        <a class="page-link" th:href="@{/admin/building/chart(page=${currentPage + 5}, size=${pageSize})}">&raquo;</a>
      </li>
    </ul>
    <!-- 페이징처리 끝 -->
    <form th:action="@{/building/list}" method="get" id="searchForm">
      <input type="hidden" id="kw" name="kw" th:value="${kw}">
    </form>
  </div>

  <script>
    const page_elements = document.getElementsByClassName("page-link");
    Array.from(page_elements).forEach(function(element) {
      element.addEventListener('click', function() {
        //document.getElementById('page').value = this.dataset.page;
        document.getElementById('searchForm').submit();
      });
    });
    const btn_search = document.getElementById("btn_search");
    btn_search.addEventListener('click', function() {
      document.getElementById('kw').value = document.getElementById('search_kw').value;
      document.getElementById('page').value = 0;  // 검색버튼을 클릭할 경우 0페이지부터 조회한다.
      document.getElementById('searchForm').submit();
    });
  </script>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
</body>
</html>